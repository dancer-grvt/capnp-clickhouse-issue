# Demo repository about CH <> Capnp issue

## Component
- Clickhouse 24.10
  - On default docker compose it'll bind to 8123 & 9000, so make sure to free those port
  - Capnp Schema: Those schema simulate 2 version of capnp (which should be backward compatible)
    - `clickouseConfig/capnpSchema/testStructOld.capnp`: Original schema
    - `clickouseConfig/capnpSchema/testStructNew.capnp`: New schema
  - SQL Schema inside `clickhouseConfig/sqlSchema` bind to those 2 table.
- MinIO
  - It'll bind to port 9001 & 9002
  - UI on 9002
- Message inside `msg` generated by `generateMsg.go`. This message is generated by old schema from client side.
  - UInt256 field is using `:Data` type inside capnp, since there's no native UInt256 data type inside capnp.

## Run the demo
1. Run the stack: `make init-stack`
2. Normal `SELECT` work on both old schema & new schema (which is reasonable since this is a safe upgrade, add 1 field into botton of schema)
   1. ` SELECT * FROM s3('http://minio:9000/msg/sample_msg_01.bin', 'minioadmin', 'minioadmin', 'capnproto') SETTINGS format_schema ='testStructOld:TestStruct'`
   2. ` SELECT * FROM s3('http://minio:9000/msg/sample_msg_01.bin', 'minioadmin', 'minioadmin', 'capnproto') SETTINGS format_schema ='testStructNew:TestStruct'`
3. `INSERT` will only work with old table & schema combination
   1. `INSERT INTO default.test_struct_old SELECT * FROM s3('http://minio:9000/msg/sample_msg_01.bin', 'minioadmin', 'minioadmin', 'capnproto') SETTINGS format_schema ='testStructOld:TestStruct'`: This will work.
   2. `INSERT INTO default.test_struct_new SELECT * FROM s3('http://minio:9000/msg/sample_msg_01.bin', 'minioadmin', 'minioadmin', 'capnproto') SETTINGS format_schema ='testStructNew:TestStruct'`: This will **not** work
4. This happen only when we add UInt256 field inside tuple, it'd work for all other data type(you can try yourself). Seem that it's due to CH do a size check before parsing String -> UInt256 and fail any empty (0 byte) field.